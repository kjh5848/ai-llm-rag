# 사내 문서 기반 AI 업무 비서 (RAG + MCP) - 전체 책 구성 및 목차

## [전체 목차]
1. [PART 0. 이 책의 목표와 최종 완성본 미리보기](#part-0)
2. [PART 0.5. 개발 환경 설정](#part-05)
3. [PART 1. FastAPI로 "초간단 사내 시스템" 만들기](#part-1)
4. [PART 2. 사내 문서 수집 전략과 문서 표준 만들기](#part-2)
5. [PART 3. VectorDB 구축: 문서를 “검색 가능한 지식”으로 바꾸기](#part-3)
6. [PART 4. RAG로 Q&A 엔진 만들기](#part-4)
7. [PART 5. 정형 MCP, 비정형 VectorDB+RAG: 통합 에이전트 설계](#part-5)
8. [PART 6. LangChain으로 연결 전략 세팅](#part-6)
9. [PART 7. RAG 튜닝: "되는 수준"에서 "쓸만한 수준"으로](#part-7)
10. [PART 8. 배포와 운영](#part-8)
11. [부록. 예제 문서 세트 및 코드 구조](#부록)

---

<div id="part-0"></div>

## PART 0. 이 책의 목표와 최종 완성본 미리보기

### 1. 목차 개요
- **목적**: 독자가 "무엇을 만들 수 있는지" 먼저 보여주고 동기 부여

### 2. 주요 내용
#### 0.1 이 책이 다루는 범위
- **Fine-tuning이 아니라 RAG + MCP**
- 모델을 재학습하지 않고, 기존 LLM에 "회사 맥락"을 주입하는 방식
- 비용 효율적 + 데이터 보안 유지 가능

#### 0.2 최종 결과물 데모 시나리오
- **정형+비정형 복합**: "김대리 남은 연차 + 휴가 규정까지 같이 알려줘" -> MCP(DB) + RAG(문서)
- **정형 데이터 조회**: "이번 달 영업팀 매출 합계 알려줘" -> MCP(DB)
- **비정형 문서 검색**: "신입사원 온보딩 절차 알려줘" -> RAG(VectorDB)
- **근거 포함 요약**: "이번 달 영업팀 매출 요약해줘(근거 포함)" -> MCP + RAG

#### 0.3 아키텍처 한 장 요약
- ChatGPT 스타일 UI (텍스트 응답 + 이미지 표시)
- LangChain Agent (Router): 정형/비정형 판단
- MCP + PostgreSQL (정형) & VectorDB + RAG (비정형)
- 인덱싱 파이프라인 (PDF 파싱 -> 텍스트/LLaVA/OCR -> Chroma VectorDB)

#### 0.4 사용 기술 스택
- **텍스트 LLM**: Ollama + DeepSeek R1
- **Vision LLM**: Ollama + LLaVA / Qwen2-VL
- **OCR**: EasyOCR
- **Backend**: FastAPI + Jinja2
- **정형 DB**: PostgreSQL
- **벡터 DB**: Chroma
- **오케스트레이션**: LangChain
- **도구 연동**: MCP
- **임베딩**: ko-sroberta-multitask

---

<div id="part-05"></div>

## PART 0.5. 개발 환경 설정

### 1. 목차 개요
- **목적**: 독자가 막힘 없이 따라할 수 있도록 환경 구축 가이드 제공

### 2. 주요 내용
#### 0.5.1 필수 요구사항
- Python 3.10 이상
- RAM 16GB 이상 (로컬 LLM 실행 시)
- 저장공간 20GB 이상

#### 0.5.2 Ollama + DeepSeek R1 설치
- Ollama 설치 (Windows/Mac/Linux)
- DeepSeek R1 모델 다운로드: `ollama pull deepseek-r1`
- 모델 테스트: `ollama run deepseek-r1`
- (옵션) GPU 설정 및 메모리 최적화

#### 0.5.3 Python 가상환경 및 의존성
- `python -m venv venv`
- `source venv/bin/activate` (Windows: `venv\Scripts\activate`)
- `pip install -r requirements.txt`

#### 0.5.4 PostgreSQL 설치 및 설정
- Docker로 PostgreSQL 실행 (권장)
- 데이터베이스/유저 생성
- 접속 테스트

#### 0.5.5 프로젝트 클론 및 초기 설정
- `git clone <repository-url>`
- `cp .env.example .env`
- `.env` 파일 수정 (DB 접속 정보, API 키 등)

#### 0.5.6 주요 의존성 목록
- **Backend**: fastapi, uvicorn, sqlalchemy, psycopg2-binary
- **AI/RAG**: langchain, chromadb, sentence-transformers
- **Parsing**: pypdf, python-docx, openpyxl

---

<div id="part-1"></div>

## PART 1. FastAPI로 "초간단 사내 시스템" 만들기

### 1. 목차 개요
- **목적**: git clone으로 바로 시작할 수 있는 기본 시스템 구축

### 2. 주요 내용
#### 1.1 프로젝트 구성
- 폴더 구조 설명
- 환경변수 설정 (.env)
- 실행 방법: `uvicorn main:app --reload`

#### 1.2 데이터 모델 설계 (3테이블)
- **employee**: id, name, dept, email, hire_date (직원 정보)
- **leave_balance**: id, employee_id, year, total, used, remaining (휴가 잔여)
- **sales**: id, dept, amount, date, description (매출 데이터)

#### 1.3 CRUD API 구현
- **직원**: 등록/조회/수정/삭제
- **휴가**: 잔여 조회/사용 등록/수정
- **매출**: 입력/기간별 조회/부서별 집계

#### 1.4 관리자 Admin UI
- Jinja2 템플릿 기반 간단한 입력 화면
- 데이터 조회/수정 폼

---

<div id="part-2"></div>

## PART 2. 사내 문서 수집 전략과 문서 표준 만들기

### 1. 목차 개요
- **목적**: “RAG는 문서 품질과 구조가 반”을 체감하게 만들기

### 2. 주요 내용
#### 2.1 어떤 문서를 넣을 것인가 (교재용 추천 세트)
- **사내 규정**: 인사/휴가/근태/보안 규정
- **업무 매뉴얼**: 신입 입사자 온보딩, 결재/보고 프로세스
- **기술 문서**: 운영 가이드, 장애 대응(runbook), 배포 절차
- **교육 자료**: 사내 교육 슬라이드/핸드북 (요약하기 좋음)
- **(옵션) FAQ**: 자주 묻는 질문/답변 (정답형 데이터)

#### 2.2 문서 형식 지원 범위
- **Markdown (.md)**: 가장 깔끔
- **PDF (.pdf)**: 텍스트 추출 필요
- **Word (.docx)**: python-docx 사용
- **Excel (.xlsx)**: 표 -> 텍스트 변환 필요
- **HWP**: PDF로 변환 후 처리 권장

#### 2.3 문서 표준 규칙 (RAG 품질의 핵심)
- **파일명 규칙**: `{부서}_{문서종류}_{버전}.pdf`
- **메타데이터**: 문서명, 버전, 발행일, 담당 부서
- **섹션 헤더 규칙**: `##, 1., 1.1` 형식 통일
- **개정 이력**: 문서 상단에 최신 순 기록

#### 2.4 문서 수집 파이프라인
- `docs/` 하위 디렉토리 구성 (hr, ops, security, onboarding, faq)

---

<div id="part-3"></div>

## PART 3. VectorDB 구축: 문서를 “검색 가능한 지식”으로 바꾸기

### 1. 목차 개요
- **목적**: 문서 -> 청크 -> 임베딩 -> VectorDB 구축의 정석

### 2. 주요 내용
#### 3.1 텍스트 추출 전략 (형식별)
- **PDF**: pypdf 또는 pdfplumber
- **DOCX**: python-docx
- **XLSX**: openpyxl -> 표를 텍스트로 정규화

#### 3.2 Chunk 설계 (초기 버전)
- **fixed-size chunk**: 500~1000자 + overlap (10~20%)
- **RecursiveCharacterTextSplitter** 사용

#### 3.3 메타데이터 설계 (검색 품질 핵심!)
- **주요 필드**: `doc_id`, `title`, `section`, `version`, `date`, `department`, `source_path`

#### 3.4 임베딩 모델 선택
- **로컬**: sentence-transformers (all-MiniLM, multilingual)
- **클라우드**: OpenAI text-embedding-3-small
- **한국어 특화**: ko-sroberta-multitask

#### 3.5 VectorDB 선택 (교재 기준)
- **Chroma**: 로컬, 빠른 시작, 교재 기준
- **(참고)**: Pinecone, Weaviate (클라우드/프로덕션용)

#### 3.6 인덱싱 실행 & 검증
- 인덱싱 스크립트 실행
- 테스트 쿼리로 검색 동작 확인
- 검색 결과 품질 검토

---

<div id="part-4"></div>

## PART 4. RAG로 Q&A 엔진 만들기

### 1. 목차 개요
- **목적**: “일단 되는 RAG”를 빨리 만든 뒤, 이후에 튜닝 파트로 확장

### 2. 주요 내용
#### 4.1 RAG 최소 동작 구현 (LangChain)
- 흐름: 질문 -> Retriever(검색) -> Prompt(컨텍스트 삽입) -> LLM -> 답변

#### 4.2 RAG 프롬프트 기본 템플릿
- 역할 설정 및 지시사항 포함
- "문서에 없는 내용은 '확인되지 않음'이라고 답하세요."
- "반드시 출처(문서명, 섹션)를 함께 제시하세요."

#### 4.3 "출처 표시" 응답 포맷
- JSON 구조 예시: `{"answer": "...", "sources": [{"title": "...", "section": "..."}]}`

#### 4.4 ChatGPT 스타일 UI 연결
- **백엔드**: `/api/chat` (POST) - 스트리밍 응답
- **프론트**: Jinja2 + JavaScript 대화형 UI
- **히스토리 관리**: 세션/DB

---

<div id="part-5"></div>

## PART 5. 정형 MCP, 비정형 VectorDB+RAG: 통합 에이전트 설계

### 1. 목차 개요
- **목적**: LLM이 “검색/DB조회”를 판단해서 조합하는 구조 만들기

### 2. 주요 내용
#### 5.1 정형/비정형 분리 원칙
- **정형 (사실/숫자)**: 휴가 잔여일, 매출 합계 -> **MCP + SQL**
- **비정형 (설명/규정)**: 휴가 규정, 온보딩 절차 -> **VectorDB + RAG**
- **복합**: 휴가 잔여 + 규정 설명 -> **MCP + RAG 조합**

#### 5.2 질문 라우팅 전략
- **규칙 기반**: 키워드 매칭 ("몇 개", "합계" -> DB)
- **스키마 기반**: 테이블 컬럼명과 매칭
- **LLM 판단**: 위 규칙으로 판단 어려울 때

#### 5.3 통합 응답 전략 (핵심!)
1. 질문 분석 -> 정형? 비정형? 둘 다?
2. 필요한 소스에서 데이터 수집
3. 통합 컨텍스트 구성
4. LLM에게 최종 답변 생성 요청

#### 5.4 대표 질문 시나리오 10개
- 정형, 비정형, 복합 사례별 질문 리스트

---

<div id="part-6"></div>

## PART 6. LangChain으로 연결 전략 세팅

### 1. 목차 개요
- **목적**: “어떤 체인/구성으로 묶을지”를 책의 표준으로 제시

### 2. 주요 내용
#### 6.1 기본 구성 3종 세트
- **Router / Agent**: 어떤 도구를 쓸지 결정
- **RAG Chain**: 문서 검색
- **MCP Tools**: DB 조회

#### 6.2 Router 전략 (추천)
- 질문 분석: "문서 검색 필요?", "DB 조회 필요?" 판단
- 실행 순서: DB 조회 -> 문서 검색 -> 최종 조합
- 응답 생성

#### 6.3 MCP Tool 설계
- `get_leave_balance(employee_name)`
- `get_sales_sum(dept, start_date, end_date)`
- `list_employees(dept)`
- `search_documents(query)`

#### 6.4 운영 설정
- **Timeout/Retry**: LLM 호출 타임아웃, 재시도 정책
- **로깅**: 프롬프트, 컨텍스트, 응답 시간 기록
- **캐싱**: 동일 질문 캐시, 임베딩 캐시
- **비용 관리**: 토큰 사용량 모니터링

---

<div id="part-7"></div>

## PART 7. RAG 튜닝: "되는 수준"에서 "쓸만한 수준"으로

### 1. 목차 개요
- **목적**: 이 파트가 책의 하이라이트. 실전 문제를 해결하는 순서대로 구성

### 2. 주요 내용
#### 7.1 증상별 튜닝 가이드
- **엉뚱한 문서**: 검색 품질 낮음 -> ReRanker, Hybrid Search
- **근거 부족**: 출처 추적 미흡 -> 메타데이터 강화, 프롬프트 수정
- **환각(Hallucination)**: 지어냄 -> 프롬프트 튜닝, 근거 강제
- **과거 데이터 인용**: 버전 관리 미흡 -> metadata filtering
- **핵심 파악 실패**: 청크 설계 문제 -> Parent Document Retriever

#### 7.2 Chunk/Retriever 튜닝
- **Semantic chunk**: 제목/문단 기반으로 전환
- **k값/Similarity threshold** 설정
- **Metadata filtering**: 최신 버전만, 부서별 필터

#### 7.3 고급 기술 적용
- **ReRanker**: 1차 검색 후 재순위화 (Cross-Encoder, Cohere, BGE)
- **Hybrid Search**: 키워드(BM25) + 벡터 결합
- **고급 Retriever**: Parent Document Retriever, Self-Query, Contextual Compression
- **Query Rewrite**: Multi-Query, HyDE, 동의어 처리

#### 7.4 프롬프트 튜닝
- 근거 우선 프롬프트 작성법
- "모르면 모른다" 강제 지시
- 답변 포맷 고정 (JSON, 표 형식)

#### 7.5 PDF 이미지 처리 전략 (하이브리드 방식)
- **문제**: DeepSeek R1은 텍스트 LLM (이미지 이해 불가)
- **해결**: LLaVA(이미지 캡션 생성) + EasyOCR(텍스트 추출)
- **메모리별 구성**: 16GB+ (Hybrid), 8-12GB (Hybrid 경량), 4-8GB (OCR 중심)

#### 7.6 평가 체계 (필수!)
- 테스트 질문 세트 (30개 이상)
- 정답 데이터셋 (예상 답변 + 출처 매핑)
- 지표: Retrieval 정확도, Answer 정확도, Hallucination Rate

---

<div id="part-8"></div>

## PART 8. 배포와 운영

### 1. 목차 개요
- **목적**: 개발 환경에서 실제 운영까지 가는 길 안내

### 2. 주요 내용
#### 8.1 배포 아키텍처
- Nginx (Reverse Proxy)
- FastAPI (Uvicorn)
- PostgreSQL & Chroma (VectorDB)
- LangChain Agent & Ollama (DeepSeek)

#### 8.2 Docker Compose 구성
- 서비스별 컨테이너 설정
- Ollama 호스트 실행 (GPU 접근)
- 볼륨 마운트 및 시크릿 관리 (API 키, DB 비번)

#### 8.3 환경 및 성능 최적화
- **환경 분리**: dev / staging / prod
- **로깅/모니터링**: Sentry, 토큰 사용량, 응답 시간
- **캐싱**: 응답 캐싱, 임베딩 캐싱
- **성능**: 동시 요청 처리 (Worker 수 조정), 벡터 DB 인덱스 최적화

#### 8.4 보안 체크리스트
- API 인증/인가 (JWT, API Key)
- HTTPS 적용
- Injection 방지 (SQL, Prompt)
- 민감 정보 마스킹 및 Rate Limiting

#### 8.5 트러블슈팅 가이드
- Ollama 응답 느림 (메모리 부족)
- 검색 결과 없음 (인덱싱 미흡)
- DB 연결 실패 (환경 설정)
- 토큰 초과 (청크 크기 조절)

---

<div id="부록"></div>

## 부록. 예제 문서 세트 및 코드 구조

### 1. 목차 개요
- **목적**: 실제 실습에 필요한 데이터와 전체 코드 조망

### 2. 주요 내용
#### A. 예제 문서 세트
- 휴가 규정 (샘플)
- 신입사원 온보딩 가이드 (샘플)
- 보안 정책 (샘플)

#### B. 테스트 질문 30선
- 정형 데이터 질문 10개
- 비정형 문서 질문 10개
- 복합 질문 10개

#### C. 코드 전체 구조
- `app/`: main, models, routers, services, templates
- `docs/`: 사내 문서
- `scripts/`: 인덱싱, 초기 데이터 생성
- `tests/`: 테스트 코드
- `docker-compose.yml`, `requirements.txt`, `.env.example`

#### D. 참고 자료
- LangChain, Chroma, Ollama 공식 문서
- RAG 관련 주요 논문 및 아티클 추천
