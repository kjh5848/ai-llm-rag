# 7장. 정형 MCP, 비정형 VectorDB+RAG: 통합 에이전트 설계

사내 지식 엔진의 진정한 가치는 파편화된 정보를 하나로 모을 때 발휘됩니다. 이번 파트에서는 정형 데이터(PostgreSQL)와 비정형 문서(Chroma)를 동시에 활용하여 사용자의 복합적인 질문에 답하는 **통합 에이전트(Integrated Agent)**의 구조를 설계합니다.

---

## 7.1 정형/비정형 분리 및 통합 원칙

AI 업무 비서가 맞닥뜨리는 질문은 크게 세 가지 유형으로 분류할 수 있습니다. 각 유형에 따라 데이터를 처리하는 엔진이 달라집니다.

1. **정형 데이터 처리(Structured Data)**
   - 대상: 인사 정보, 매출 수치, 연차 잔여량 등 수치와 팩트 중심 데이터.
   - 엔진: **MCP + SQL(PostgreSQL)**. 팩트는 정확한 쿼리를 통해 조회해야 합니다.

2. **비정형 지식 검색(Unstructured Knowledge)**
   - 대상: 사내 규정, 업무 매뉴얼, 온보딩 가이드 등 텍스트 중심의 지식.
   - 엔진: **VectorDB + RAG(Chroma)**. 지식은 의미 기반 검색(Semantic Search)을 통해 추출합니다.

3. **복합 질문 처리(Hybrid Reasoning)**
   - 대상: "내 남은 연차(정형)와 휴가 신청 절차(비정형)를 한 문장으로 요약해줘."
   - 엔진: **통합 에이전트(Orchestrator)**. 두 엔진의 결과를 합성(Synthesis)하여 답변합니다.

---

## 7.2 통합 에이전트의 사고 흐름

사용자가 복합 질문을 던졌을 때, 에이전트는 다음과 같은 단계로 사고(Reasoning) 과정을 거칩니다.

### 1단계: 질문 분석 및 라우팅(Question Routing)
사용자의 발화 의도를 분석하여 필요한 도구(Tool)를 선택합니다.
- "김대리의 남은 연차 확인" -> **DB 조회 도구** 필요
- "휴가 규정 확인" -> **문서 검색 도구** 필요

### 2단계: 데이터 병렬 수집(Parallel Retrieval)
각 도구를 실행하여 필요한 파편 정보를 모읍니다.
- **MCP**: `SELECT remaining_leave FROM leave_balance WHERE name = '김대리';` -> 결과: "5일"
- **RAG**: "휴가 규정 2.3절: 연차 사용 시 3일 전 결재 필요..." -> 결과: 문서 발췌문

### 3단계: 지식 합성 및 답변 생성(Synthesis & Response)
모아진 서로 다른 형태의 데이터를 LLM이 읽고, 하나의 자연스러운 문장으로 재구성합니다.

---

## 7.3 [이미지] 정형+비정형 복합 처리 흐름도

*(이미지 생성량 초과로 인하여, 시각화 가이드 시스템 v7 규칙에 따른 도식 설명을 대체 기재합니다.)*

> **도식 구조 설명**: 
> 1. 중앙의 `AI` 원형 심볼에서 두 개의 선이 뻗어 나갑니다.
> 2. 왼쪽 선은 `MCP (SQL)` 박스로 연결되어 데이터베이스의 수치를 가져옵니다.
> 3. 오른쪽 선은 `VectorDB (SEARCH)` 박스로 연결되어 문서의 텍스트를 가져옵니다.
> 4. 아래쪽으로 향하는 굵은 화살표 `SYNTHESIS`를 통해 최종 답변이 출력되는 구조입니다.

---

## 7.4 대표 시나리오: 정형+비정형 복합 처리 사례

**사용자 질문**
> "이팀장님 남은 연차 개수와 올해 바뀐 휴가 규정을 한꺼번에 알려주세요."

**에이전트 처리 결과 예시**
1. **DB 조회**: 이팀장님의 잔여 연차는 **12일**입니다.
2. **문서 검색**: 올해 개정된 규정에 따르면, 연차 보상비 지급 기준이 **월 급여의 50%에서 70%로 상향**되었습니다.
3. **최종 답변**: "이팀장님의 현재 잔여 연차는 **12일**이며, 올해 변경된 규정에 따라 미사용 연차에 대한 보상비는 **월 급여의 70%** 기준으로 지급될 예정입니다."

---

> **연결 고리**: 설계를 마쳤다면 이제 실제로 하나씩 구현할 차례입니다. **8장**에서는 LangChain의 `Tool Calling` 기능을 활용하여 이 설계를 실제 파이썬 코드로 동작시키는 과정을 실습합니다.
